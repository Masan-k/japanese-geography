<!DOCTYPE html>
<html data-bs-theme="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="Cache-Control" content="no-store" />
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
    <title>loopeeTokyo</title>
    <!-- Bootstrap CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap JS -->
    <script src="js/bootstrap.bundle.min.js"></script>

  </head>
  
  <body>
    <div class="mx-auto d-block" style="width:90%;">
      <h1 class="text-center mt-2" id="gameStatus">gameStatus</h1>
      <div class="input-group">
        <span class="input-group-text" id="questionCode">XX</span>
        <input type="text" class="form-control" aria-describedby="questionCode" placeholder="Enter the answer">
      </div>
    </div>
    <div class="text-center mt-3" style="">
      <div class="btn-group" role="group" style="width:95%;">
        <input type="radio" class="btn-check" name="btnradio" id="radioEasy1" data-index="easy1">
        <label class="btn btn-outline-primary" for="radioEasy1">EASY I</label>
        <input type="radio" class="btn-check" name="btnradio" id="radioEasy2" data-index="easy2">
        <label class="btn btn-outline-primary" for="radioEasy2">EASY II</label>
        <input type="radio" class="btn-check" name="btnradio" id="radioNormal" data-index="normal">
        <label class="btn btn-outline-primary" for="radioNormal">NORMAL</label>
        <input type="radio" class="btn-check"  name="btnradio" id="radioHard" data-index="hard">
        <label class="btn btn-outline-primary" for="radioHard">HARD</label>
      </div>

      <div class="mt-2">
        <div class="btn-group" role="group">
          <input type="checkbox" class="btn-check btn-success" id="checkCode1" name="selectCode">
          <label class="btn btn-outline-success" for="checkCode1">1</label>
          <input type="checkbox" class="btn-check btn-success" id="checkCode2" name="selectCode">
          <label class="btn btn-outline-success" for="checkCode2">2</label>
          <input type="checkbox" class="btn-check btn-success" id="checkCode3" name="selectCode">
          <label class="btn btn-outline-success" for="checkCode3">3</label>
        </div>
        <div class="btn-group" role="group">
          <input type="checkbox" class="btn-check" id="checkCode4" name="selectCode">
          <label class="btn btn-outline-primary" for="checkCode4">4</label>
          <input type="checkbox" class="btn-check" id="checkCode5" name="selectCode">
          <label class="btn btn-outline-primary" for="checkCode5">5</label>
          <input type="checkbox" class="btn-check" id="checkCode6" name="selectCode">
          <label class="btn btn-outline-primary" for="checkCode6">6</label>
        </div>
      </div>
    </div>

    <div class="mt-2 mb-2 text-center">
      <input type="button" class="btn btn-primary" value="START" id="buttonStart" onclick="clickStart()">
      <input type="button" class="btn btn-primary" value="SUBMIT" id="buttonSubmit" style="display:none;" onclick="clickSubmit()">
      <input type="button" class="btn btn-primary" value="TEST" id="buttonTest" onclick="clickTest()">
    </div>

    <div id="main-container"></div>
    <div id="sub-container"></div>
    <label id="hint"></label><br>
    <script type="module">
      import * as question from './js/question.js';
      import * as svg from './js/svg.js';
      let m_clickCount = 0;
      let m_readyCount = 0;
      let m_jsonData;
      const DEFAULT_MODE = 'easy2';
      // 初期選択のTARGET_CODEは対応しない
      // 理由：マークをマップ書き込み後に処理するのにobserverが必要で
      //       実装に時間がかかるため
      // const DEFAULT_TARGET_CODE = 'checkCode4';

      init();

      function init(){
        const REQUEST_URL = './contents.json';
        let request = new XMLHttpRequest(); 
        const eleCheckboxCodes = document.querySelectorAll('input[name="selectCode"]');
        const eleRadios = document.querySelectorAll('input[name="btnradio"]');

        eleCheckboxCodes.forEach(checkbox => {
          checkbox.addEventListener('change', function(){
            svg.drawMarkToGroupCode(m_jsonData,getSelectedTargetCodes(),getSelectedMode());
          });
        });

        window.clickSubmit = clickSubmit;
        window.clickPlay = clickPlay;
        window.clickStart = clickStart;
        window.clickTest = clickTest;

        request.open('GET', REQUEST_URL);
        request.responseType = 'json';
        request.send();
        request.onload = function (){
          m_jsonData = request.response;
          setParameter();
          setStatus('select');
        }

        function setParameter(){
          let param = location.search.split('&');
          let mode;
          let groupCode;
          //const eleCheckboxCodes = document.querySelectorAll('input[name="selectCode"]');
          const eleRadios = document.querySelectorAll('input[name="btnradio"]');

          if(param.length === 1){
            console.log('check1');
            console.log("location.search.split('&')");
            console.log(location.search.split('&'));
            mode = param[0].split('=')[1];
            console.log('mode');
            console.log(mode);
            //groupCode = param[1].split('=')[1];
          }else{
            console.log('check2');
            mode = DEFAULT_MODE;
            //groupCode = DEFAULT_TARGET_CODE;
          }

          eleRadios.forEach(radio => {
            if(mode === radio.dataset.index){
              radio.checked = true;
            }
          }); 
        }
      }  // init end


      function setStatus(mode){
        if(mode === 'select'){
          document.getElementById("gameStatus").textContent = 'Click START..';
          svg.drawMapFullMainContainer();
        }
      }
      function getSelectedMode(){
        const eleRadios = document.querySelectorAll('input[name="btnradio"]');
        for (const radio of eleRadios) {
          if (radio.checked) {
            return radio.dataset.index;
          }
        }
        return null;
      } 
      function getSelectedTargetCodes(){
        const eleCheckboxCodes = document.querySelectorAll('input[name="selectCode"]');
        let selectGroupCodes = [];
        eleCheckboxCodes.forEach(checkbox => {
          const label = document.querySelector('label[for='+ checkbox.id  +']');
          if(checkbox.checked){
            selectGroupCodes.push(label.textContent);
          }
        });
        return selectGroupCodes;
      }

      function clickPlay(){
        console.log('click play');
      }
      function clickSample(){
        console.log('call clickSample');
      }
      function clickTest(){
        svg.drawMarkToGroupCode(m_jsonData,getSelectedTargetCodes(),getSelectedMode());
      }
      function clickStart(){
        question.setData(m_jsonData,getSelectedMode(),getSelectedTargetCodes());
        main();
        function main(){
          document.getElementById("gameStatus").textContent =  '...';
          svg.setObserverGame();
          document.getElementById("questionCode").innerText = question.questionCode[m_clickCount];
          svg.draw(question.pos[m_clickCount][0],question.pos[m_clickCount][1]);
          document.getElementById("buttonSubmit").style.display = "inline-block";
          document.getElementById("buttonStart").style.display = "none";
        }
        function setHint(){
          for (let index in question.answer) {
            if(question.kana[index].length > 0){
              document.getElementById('hint').textContent += question.answer[index] + "(" + question.kana[index] +")/";
            }else{
              document.getElementById('hint').textContent += question.answer[index] + "/";
            }
          }
        }
      }
      function clickSubmit(){
        if(typeof question.pos != 'undefined'){
          document.getElementById("questionCode").innerText = question.questionCode[m_clickCount];
          svg.draw(question.pos[m_clickCount][0],question.pos[m_clickCount][1]);
          m_clickCount += 1;
        }
      }
    </script>
  </body>
</html>
