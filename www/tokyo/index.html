<!DOCTYPE html>
<html data-bs-theme="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="Cache-Control" content="no-store" />
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
    <title>loopeeTokyo</title>
    <!-- Bootstrap CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap JS -->
    <script src="js/bootstrap.bundle.min.js"></script>

  </head>
  
  <body>
    <div class="mx-auto d-block" style="width:90%;">
      <h1 class="text-center mt-2" id="gameStatus">gameStatus</h1>
      <div class="input-group">
        <span class="input-group-text" id="questionCode" style="width:15%;">XX</span>
        <input type="text" class="form-control" aria-describedby="questionCode" placeholder="Enter the answer">
      </div>
    </div>
    
    <div class="text-center mt-3" id="select-container">
      <div class="btn-group" role="group" style="width:95%;">
        <input type="radio" class="btn-check" name="btnradio" id="radioEasy1" data-index="easy1">
        <label class="btn btn-outline-primary" for="radioEasy1">EASY I</label>
        <input type="radio" class="btn-check" name="btnradio" id="radioEasy2" data-index="easy2">
        <label class="btn btn-outline-primary" for="radioEasy2">EASY II</label>
        <input type="radio" class="btn-check" name="btnradio" id="radioNormal" data-index="normal">
        <label class="btn btn-outline-primary" for="radioNormal">NORMAL</label>
        <input type="radio" class="btn-check"  name="btnradio" id="radioHard" data-index="hard">
        <label class="btn btn-outline-primary" for="radioHard">HARD</label>
      </div>

      <div class="mt-2">
        <div class="btn-group" role="group">
          <input type="checkbox" class="btn-check btn-success" id="checkCode1" name="selectCode">
          <label class="btn btn-outline-success" for="checkCode1">1</label>
          <input type="checkbox" class="btn-check btn-success" id="checkCode2" name="selectCode">
          <label class="btn btn-outline-success" for="checkCode2">2</label>
          <input type="checkbox" class="btn-check btn-success" id="checkCode3" name="selectCode">
          <label class="btn btn-outline-success" for="checkCode3">3</label>
        </div>
        <div class="btn-group" role="group">
          <input type="checkbox" class="btn-check" id="checkCode4" name="selectCode">
          <label class="btn btn-outline-primary" for="checkCode4">4</label>
          <input type="checkbox" class="btn-check" id="checkCode5" name="selectCode">
          <label class="btn btn-outline-primary" for="checkCode5">5</label>
          <input type="checkbox" class="btn-check" id="checkCode6" name="selectCode">
          <label class="btn btn-outline-primary" for="checkCode6">6</label>
        </div>
        <input type="button" class="btn btn-primary" value="START" id="buttonStart" onclick="clickStart()">
        <input type="button" class="btn btn-primary" value="TEST" id="buttonTest" onclick="clickTest()">
      </div>
    </div>

    <div class="mt-2 mb-2 text-center">
      <input type="button" class="btn btn-primary" value="SUBMIT" id="buttonSubmit" style="display:none;" onclick="clickSubmit()">
    </div>

    <div id="main-container"></div>
    <div id="sub-container"></div>
    <div id="progress-container" class='mt-3 progress' role='progressbar' aria-valuenow="10" aria-valuemin="0" aria-valuemax="100">
       <div id="progress" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 50%">50%</div>
    </div>
    <label id="hint"></label><br>
    <script type="module">
      const DEFAULT_MODE = 'easy2';
      const TIME_LIMIT = 15;
      const GREAT_LIMIT = 5;
      const GOOD_LIMIT = 10;

      import * as question from './js/question.js';
      import * as svg from './js/svg.js';

      let m_clickCount = 0;
      let m_jsonData;
      let m_gameStartTime;
      let m_answerStartTime; 

      // 初期選択のTARGET_CODEは対応しない
      // 理由：マークをマップ書き込み後に処理するのにobserverが必要で
      //       実装に時間がかかるため
      // const DEFAULT_TARGET_CODE = 'checkCode4';
      init();
      function init(){
        const REQUEST_URL = './contents.json';
        const eleCheckboxCodes = document.querySelectorAll('input[name="selectCode"]');
        const eleRadios = document.querySelectorAll('input[name="btnradio"]');
        let request = new XMLHttpRequest(); 

        window.clickSubmit = clickSubmit;
        window.clickPlay = clickPlay;
        window.clickStart = clickStart;
        window.clickTest = clickTest;

        eleCheckboxCodes.forEach(checkbox => {
          checkbox.addEventListener('change', function(){
            svg.drawMarkToGroupCode(m_jsonData,getSelectedTargetCodes(),getSelectedMode());
          });
        });


        eleRadios.forEach(radio => {
          if(DEFAULT_MODE === radio.dataset.index){
            radio.checked = true;
          }
        }); 

        request.open('GET', REQUEST_URL);
        request.responseType = 'json';
        request.send();
        request.onload = function (){
          m_jsonData = request.response;
          setStatus('select');
        }
      }  // init end

      function updateProgress(time){
        const progressBar = document.getElementById('progress');
        let parsent = 100-(time*100/TIME_LIMIT).toFixed(0);
        let sec = TIME_LIMIT-time.toFixed(0);
        progressBar.style.width = parsent + '%';
        progressBar.textContent = sec + 'sec';
        progressBar.setAttribute('aria-valuenow',parsent);

        if(GREAT_LIMIT > time){
          if(progressBar.classList.contains('bg-warning')){
           progressBar.classList.remove('bg-warning');
          }
          if(progressBar.classList.contains('bg-danger')){
            progressBar.classList.remove('bg-danger');
          }

        }else if(GOOD_LIMIT > time && time > GREAT_LIMIT){
          if(!progressBar.classList.contains('bg-warning')){
            progressBar.classList.add('bg-warning');
          }
        }else if(time > GOOD_LIMIT){
          if(!progressBar.classList.contains('bg-danger')){
            progressBar.classList.add('bg-danger');
          }
          if(progressBar.classList.contains('bg-warning')){
           progressBar.classList.remove('bg-warning');
          }
        }
      }
      function setStatus(gameStatus){
        if(gameStatus === 'select'){
          document.getElementById("gameStatus").textContent = 'Click START..';
          svg.drawMapFullMainContainer();

        }else if(gameStatus === 'mainInit'){
          question.setData(m_jsonData,getSelectedMode(),getSelectedTargetCodes());

          document.getElementById("gameStatus").textContent =  '...';
          document.getElementById("questionCode").innerText = question.code[m_clickCount];
          document.getElementById("buttonSubmit").style.display = "inline-block";
          document.getElementById("buttonStart").style.display = "none";
          document.getElementById("select-container").style.display = "none";
          svg.setObserverGame();
          svg.draw(question.pos[m_clickCount][0],question.pos[m_clickCount][1]);
          m_clickCount += 1;

          m_gameStartTime = Date.now();
          m_answerStartTime = Date.now();

          if(getSelectedMode() === 'easy1' || getSelectedMode() === 'easy2'){
            //setHint
            for (let index in question.answer) {
              if(question.kana[index].length > 0){
                document.getElementById('hint').textContent += question.answer[index] + "(" + question.kana[index] +")/";
              }else{
                document.getElementById('hint').textContent += question.answer[index] + "/";
              }
            }
          }

        }else if(gameStatus === 'main'){
          console.log('call main');
          let intervalId = setInterval(() => {
            const eleGameStatus = document.getElementById('gameStatus')
            eleGameStatus.textContent = ((Date.now() - m_gameStartTime) / 1000).toFixed(1);
            let elapsedTime = (Date.now() - m_answerStartTime) / 1000;
            updateProgress(elapsedTime);
          },100);
        }
      }
      function getSelectedMode(){
        const eleRadios = document.querySelectorAll('input[name="btnradio"]');
        for (const radio of eleRadios) {
          if (radio.checked) {
            return radio.dataset.index;
          }
        }
        return null;
      } 
      function getSelectedTargetCodes(){
        const eleCheckboxCodes = document.querySelectorAll('input[name="selectCode"]');
        let selectGroupCodes = [];
        eleCheckboxCodes.forEach(checkbox => {
          const label = document.querySelector('label[for='+ checkbox.id  +']');
          if(checkbox.checked){
            selectGroupCodes.push(label.textContent);
          }
        });
        return selectGroupCodes;
      }

      function clickPlay(){
        console.log('click play');
      }
      function clickSample(){
        console.log('call clickSample');
      }
      function clickTest(){
        /*
        console.log('call clickTest');
        const progressBar = document.getElementById('progress');
        if(progressBar.classList.contains('bg-warning')){
          progressBar.classList.remove('bg-warning');
          progressBar.classList.add('bg-danger');
        }else if(progressBar.classList.contains('bg-danger')){
          progressBar.classList.remove('bg-danger');
        }else{
          progressBar.classList.add('bg-warning');
        }
        */
      }

      function clickStart(){
        if(getSelectedTargetCodes().length === 0){
          alert("Please select a number.");

        }else{
          setStatus('mainInit');
          setStatus('main');
        }
      }
      function clickSubmit(){
        if(typeof question.pos != 'undefined'){
          document.getElementById("questionCode").innerText = question.code[m_clickCount];
          svg.draw(question.pos[m_clickCount][0],question.pos[m_clickCount][1]);
          m_clickCount += 1;
        }
      }
    </script>
  </body>
</html>
